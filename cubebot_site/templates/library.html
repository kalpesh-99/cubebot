{% extends "base.html" %}


{%block title%}
<title>My Library</title>
{% endblock %}

{% block nav %}

{% endblock %}

{%block content%}

<div class="page">
  <div class="jumbotron" style="margin-top: 15px; padding-top: 0px; padding-bottom: 10px; margin-bottom: 10px">
      <div class="container">
        {% if current_user.is_authenticated %}
      <h2>
            Hi  {% if current_user.FBname %} {{ current_user.FBname }}
                {% else %} {{ current_user.username }}
                {% endif %}
      </h2>
      {% endif %}
      <h3 style="margin-top: 10px"> Select a file to share</h3>
        <!-- <p>A friendly bot that keeps files organized 1 byte at a time.</p> -->
        <!-- <p><a class="btn btn-primary btn-lg" href="#" role="button">Add Sources</a></p> -->
    </div>
  </div>
  <div class="jumbotron col-xs-12" style="margin-right: 3px; padding-top: 0px; padding-bottom: 10px; padding-right: 5px; padding-left: 5px;">
      <div class="col-xs-6">
        {% if current_user.is_authenticated %}
          <h3>Groups </h3>
      {% endif %}
      </div>
      <div class="col-xs-6">
        {% if current_user.is_authenticated %}
          <h3> Friends </h3>
      {% endif %}
      </div>
  </div>
  <!-- <div class="jumbotron col-xs-6" style="margin-left: 0px; padding-top: 0px; padding-bottom: 10px; padding-right: 5px; padding-left: 5px;">
      <div class="container">
        {% if current_user.is_authenticated %}
          <h3> Friends </h3>
      {% endif %}
      </div>
  </div> -->



  <div id="createDiv">

  </div>

<!-- <div id="textbox">Mary had a bigger lamb</div> -->
<!-- <div id="textbox" >Mary had a smaller lamb</div>
<button onclick="select_all_and_copy(document.getElementById('textbox'))">Copy to Clipboard</button> -->

  <script type="text/javascript" src="{{url_for('.static', filename='js/copy2clipboard.js')}}" >
  </script>
  <div class="kali">







<!-- <p><a href="#" id="test-button" class="btn btn-default" style="border-color: #936cca; color: #936cca" role="button">Test Share</a></p> -->
<!-- <div><ul id="post-success">Was successful</ul></div> -->
<div id="contextData">
  <p>
    Current PSiD: <span class="profileID"> </span>
  </p>
  <p>
    Current TiD: <span class="threadID"> </span>
  </p>
  <p>
    Current Thread Type: <span class="threadType"> </span>
  </p>
</div>

<!-- <p><a href="#" id="close-button" class="btn btn-default" style="border-color: #936cca; color: #936cca" role="button">Close Button</a></p> -->

</div>

{% endblock %}

{% block moreScript%}

<!-- <script src="{{url_for('.static', filename='js/custom.js')}}"> -->


<script>



// ##############################################################################################################
// ##############################################################################################################

// ATTENTION  HOMER
// here's the script section i'm working on...
// End Goal: I want to add an 'src=' value from the imageUrls list below to the above <img id="content-image" src=" "  /> (where the context loop was happening).
// I can't seem to figure out the right way to do so. Below are a few little steps i've take, mostly just for me to understand how to work with jqeury/javascript

var imageUrls = {{ imageUrlList|safe }};
// this creates a list of image urls (passed in from my view) and i want to add each element as a new img src in the above html

var contentTitle = {{ titleList|safe}};
var contentID = {{ idList|safe}};
var contentURL = {{ urlList|safe}};

console.log(contentID);
console.log(contentTitle);
console.log(contentURL);
console.log(imageUrls);


alert(contentID.length);
for (i = 0; i < contentID.length; ++i) {

    var nT = $('<div class="thumbnail" ><div class="caption"><h3>new title div</h3></div></div>');
    $('#createDiv').append(nT);
    nT.attr('id', i);
    // nT.html(contentTitle[i]);

    // var nImage = $('<img id="content-image" src=" " alt="image missing" >');
    // nImage.attr('src', imageUrls[i]);


    nT.html('<a href=' +(contentURL[i]) +'><img src=' +(imageUrls[i]) +'></a><h3 class="shareTitle">' +contentTitle[i] +'</h3>');


    var nURL = $('<div class="container shareURL" id="shareURL"<p style="font-size: 6px; overflow: hidden; text-overflow: ellipsis">www.abc.com</p></div>');
    // var nURL = $('<textarea class="container shareURL" id="shareURL" style="font-size: 6px; overflow: hidden; text-overflow: ellipsis">www.abc.com</textarea>');
    nURL.html(contentURL[i]);
    nT.append(nURL);

    var nButton = $('<br /><p class="tracker"><div class="copy-button btn btn-default" role="button">Copy Link</div> <a href="#" class="share-button btn btn-default" style="border-color: #936cca; color: #936cca" role="button">Messenger</a></p>');
    nT.append(nButton);
    nButton.attr('id', contentID[i]);

    // var nShare = $('<input type="text" onFocus="this.selectionStart=0; this.selectionEnd=this.value.length;" onTouchEnd="this.selectionStart=0; this.selectionEnd=this.value.length;" onMouseUp="return false" class="copyLink" style="display:none" value="share link goes here" />');
    // nShare.attr('value', contentURL[i]);
    // nT.append(nShare);
    var nShare = $('<input type="text" id="textbox1" class="copyLink" style="display:none" value="share link goes here" />');
    nShare.attr('value', contentURL[i]);
    nT.append(nShare);
// <button onclick="select_all_and_copy(document.getElementById('textbox'))">Copy to Clipboard</button>

};

// just for testing purposes, to see if I could create new divs using the array length loop by selecting id=createDiv


// for (i = 0; i < imageUrls.length; ++i) {
//     var image = imageUrls[i];
//     console.log(image + "looking for log of image urls")
// };
// just for testing purpuse, to make sure I could correctly read the list items and log them to console


//
//**** this actually works, but it's not itterating through the list ****
// var imgURL = "https://i.ytimg.com/vi/uN6geTvvZDk/hqdefault.jpg";
// $("#content-image").each(function() {
//   var src = $(this).attr('src');
//   src = imgURL
//   $(this).attr('src', src)
// });

// ##############################################################################################################
// ##############################################################################################################

$(".copy-button").click(function() {
  if ($(this).text() == "Close") {
    $(this).nextAll('.copyLink').first().toggle('slow', function() {
      // Animation complete.
      });
    $(this).text("Copy Link");
    }
    else {
  $(this).nextAll('.copyLink').first().toggle('slow', function() {
    // Animation complete.
  });
  $(this).text("Close");
  // select_all_and_copy(document.getElementById('textbox'));
  // $(this).nextAll('.copyLink').first().css({'color': 'red'});
  select_all_and_copy($(this).nextAll('.copyLink').first()[0]);
  }
});

// modify this code per seabreeze computers copy 2 clipboard example...
// var $input = $(' some input/textarea ');
// $input.val(result);
// if (navigator.userAgent.match(/ipad|ipod|iphone/i)) {
//   var el = $input.get(0);
//   var editable = el.contentEditable;
//   var readOnly = el.readOnly;
//   el.contentEditable = true;
//   el.readOnly = false;
//   var range = document.createRange();
//   range.selectNodeContents(el);
//   var sel = window.getSelection();
//   sel.removeAllRanges();
//   sel.addRange(range);
//   el.setSelectionRange(0, 999999);
//   el.contentEditable = editable;
//   el.readOnly = readOnly;
// } else {
//   $input.select();
// }
// document.execCommand('copy');
// $input.blur();



$(".share-button").click(function() {

  // var tracker = parseInt($("#tracker").text());
  // var sharingID = $(this).parent().closest("p").attr('id');
  var sharingID = $(this).prevAll('p.tracker').attr('id');
  var sharingPSID = resPSID;
  var sharingTID = resTID;
  var sharingType = resTYPE;
  // alert(sharingID);
  // alert(sharingPSID);
  // alert(sharingTID);
  // alert(sharingType);

  // alert(tracker);




  var data = {
    "file": sharingID,
    "recepient_id": sharingPSID,
    "thread_id" : sharingTID,
    "thread_type": sharingType
  };



  // var title = $(this).parent('.tracker').attr('id');
  var title = $(this).prevAll('h3.shareTitle').text();
  // alert(title);
  var url = $(this).prevAll('div.shareURL').text();
  // alert(url);
  var imageUrl = $(this).prevAll('a').find('img').attr('src');
  // alert(imageUrl);


  var messageToShare = {
        "attachment":{
           "type":"template",
           "payload":{
               "template_type":"generic",
               "elements": [{
                 "title": title,
                 "image_url": imageUrl,
                //  "subtitle": "On the pitch celebrations from Stanford Bridge",
                 "default_action":{
                     "type":"web_url",
                     "url": url
                   },
                   "buttons":[{
                     "type":"web_url",
                     "url":"https://www.youtube.com/results?search_query=" +title,
                     "title":"Search YouTube for More"
                   }]
               }]
           }
        }
      };


// This will send data directly to FB Messenger server
  MessengerExtensions.beginShareFlow(function success(response) {
    // Share successful
    if (response.is_sent) {

          $.ajax({
              type : "POST",
              url : "/_load_ajax",
              data: JSON.stringify(data),
              contentType: 'application/json',
              success: function(result) {
                console.log(result);
                // $("#post-success").show();
              },

              error: function(error) {
                console.log(error);
              },

          }),


          MessengerExtensions.requestCloseBrowser(function success() {


         }, function error(err) {

         });
      }
    }, function error(errorCode, errorMessage) {
    // The user was not able to share

    },
    messageToShare,
    "current_thread");

// alert("something");
});



</script>




{% endblock %}

{% block asyncScript%}


<script>
var resPSID;
var resTID;
var resTYPE;

window.extAsyncInit = function() {
  alert("Messenger Extensions JS SDK is done loading");
  MessengerExtensions.getContext(
    '1863368713926932',
    function success(result) {
      var psid = result.psid;
      var tid = result.tid;
      var thread_type = result.thread_type;
      $('.profileID').html(psid);
      $('.threadID').html(tid);
      $('.threadType').html(thread_type);
      resPSID = psid;
      resTID = tid;
      resTYPE = thread_type;

    }, function error(result) {
      console.log(result)
    });
};
</script>
{% endblock %}
